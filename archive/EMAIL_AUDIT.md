# Eras Email System - Complete Audit

## Overview
Eras uses **Resend API** (resend.com) to send transactional emails from the verified domain **`noreply@erastimecapsule.com`**.

**Email Service Provider:** Resend (https://resend.com)  
**Sending Domain:** erastimecapsule.com (verified)  
**From Address:** noreply@erastimecapsule.com  
**Rate Limit:** 2 requests/second (600ms minimum delay between sends)  
**API Key Environment Variable:** `RESEND_API_KEY`

---

## Email Templates - Complete List

### **1. Capsule Delivery Email** üì¶
**File Location:** `/supabase/functions/server/email-service.tsx` ‚Üí `generateCapsuleEmail()`  
**Sent By:** `EmailService.sendCapsuleDelivery()`  
**Triggered When:**
- Automated delivery system processes a scheduled capsule (runs every 2 minutes via cron)
- Capsule reaches its scheduled `delivery_date`
- Recipient claims a pending capsule (for "others" delivery type)

**Two Variations:**

#### **1A. Self-Delivery Email** (Capsule to yourself)
- **Subject:** `"Your Time Capsule Has Arrived ‚Äî A Message from Your Past Self"`
- **Content:**
  - Header: *"Your Eras capsule has just been unlocked ‚Äî a message from you, sent across time."*
  - Subheader: *"Take a deep breath and open it when you're ready ‚Äî this is a moment you created for yourself."*
  - Call-to-Action Button: **"Open Capsule"** (links to viewing URL)
  - Closing: *"Welcome back to your own story."*
  - Footer: Support contact (support@erastimecapsule.com)

#### **1B. Shared Capsule Email** (Capsule from someone else)
- **Subject:** `"You've Received a Time Capsule from {SENDER_NAME}!"`
- **Content:**
  - Header: *"Surprise! Someone from another moment in time has sent you a message through Eras."*
  - Subheader: *"Inside is something they wanted you to see, hear, or feel ‚Äî and now, finally, it's time."*
  - **Sender Info Box:** Shows "From: {SENDER_NAME}" in a highlighted box
  - Call-to-Action Button: **"Open Capsule"** (links to viewing URL)
  - Closing: *"Open it when you're ready. Some moments are meant to arrive right on time."*
  - Footer: Support contact (support@erastimecapsule.com)

**Data Included:**
- Capsule title
- Text message preview
- Sender name (for shared capsules)
- Delivery date (formatted)
- Viewing URL (deep link with auth token)
- Media file count (not shown in email, but tracked)

**Technical Notes:**
- ‚úÖ Deduplication enabled (prevents duplicate emails via KV store tracking)
- ‚úÖ Deep linking to viewing URL (auto-handles auth state)
- ‚úÖ Signed URLs for media files (valid for 7 days)
- ‚úÖ In-app notification also created when delivered

---

### **2. Password Reset Email** üîê
**File Location:** `/supabase/functions/server/email-service.tsx` ‚Üí `sendPasswordResetEmail()`  
**Sent By:** `EmailService.sendPasswordResetEmail()`  
**Triggered When:**
- User clicks "Forgot Password" and enters their email
- API endpoint: `/api/auth/request-password-reset`

**Content:**
- **Subject:** `"Reset Your Eras Password"`
- **Greeting:** "Hi {FIRST_NAME}" or "Hi there" (if name unavailable)
- **Body:**
  - *"We received a request to reset your password for your Eras account."*
  - *"Click the button below to create a new password:"*
  - Call-to-Action Button: **"Reset Password"** (links to Supabase reset URL)
  - *"This link will expire in 1 hour."*
  - Security note: *"If you didn't request this, you can safely ignore this email."*
- **Footer:** 
  - Link expiration notice (1 hour)
  - Support contact (support@erastimecapsule.com)

**Data Included:**
- User's email
- User's first name (if available from profile)
- Password reset URL (generated by Supabase Auth)
- Redirect URL (points to /reset-password page)

**Technical Notes:**
- ‚úÖ Uses Supabase Auth's `generateLink()` for secure reset tokens
- ‚úÖ Rate limiting protection (429 error handled)
- ‚úÖ Returns success for non-existent emails (prevents user enumeration attacks)
- ‚úÖ Link expires in 1 hour

---

### **3. Delivery Confirmation Emails** ‚úâÔ∏è **[DISABLED]**
**File Location:** `/supabase/functions/server/email-service.tsx` ‚Üí `sendDeliveryNotification()`  
**Sent By:** `EmailService.sendDeliveryNotification()`  
**Status:** **DISABLED** (lines 602-616 in delivery-service.tsx)

**Why Disabled:**
- To prevent rate limit issues with Resend API
- Users can check delivery status in the Dashboard instead
- Reduces email noise for senders

**If Re-Enabled, Would Send:**

#### **3A. Success Confirmation**
- **Subject:** `"[SUCCESS] Time capsule \"{TITLE}\" delivered successfully"`
- **Content:** Confirmation that capsule was delivered to recipient

#### **3B. Failure Notification**
- **Subject:** `"[FAILED] Failed to deliver time capsule \"{TITLE}\""`
- **Content:** Notification that delivery failed with reason

---

## Email Triggers & Workflows

### **Automated Delivery System** ‚è∞
**Cron Schedule:** Every 2 minutes  
**Function:** `DeliveryService.processDueDeliveries()`

**Process:**
1. Query all capsules with `status='scheduled'` and `delivery_date <= NOW`
2. For each due capsule:
   - Acquire per-capsule lock (prevents duplicates)
   - Re-fetch latest capsule data
   - Check if already delivered (duplicate protection)
   - Extract recipient info (self_contact or recipients array)
   - Generate viewing URL with unique token
   - **Send email via EmailService.sendCapsuleDelivery()**
   - Mark capsule as `status='delivered'`
   - Add to recipient's received list
   - Create in-app notification
   - Release capsule lock
3. Release global delivery lock

**Email Recipients:**
- **Self-delivery:** User's email from `self_contact` field or fallback to auth email
- **Others-delivery:** All emails in `recipients` array

**Fallback Behavior:**
- If `self_contact` is empty ‚Üí uses user's auth email
- SMS delivery not supported (email only)

---

### **Password Reset Flow** üîë
**Trigger:** User clicks "Forgot Password"  
**API Endpoint:** `POST /make-server-f9be53a7/api/auth/request-password-reset`

**Process:**
1. User enters email address
2. Backend generates reset token via Supabase Auth
3. Tries to fetch user's first name from profile (`profile:{email}`)
4. **Sends email via EmailService.sendPasswordResetEmail()**
5. Returns success (even if email doesn't exist - security best practice)

---

### **Pending Capsule Claims** üì®
**Trigger:** User signs up or logs in with email that has pending capsules  
**API Endpoint:** `POST /make-server-f9be53a7/api/capsules/claim-pending`

**Process:**
1. Check `pending_capsules:{email}` in KV store
2. For each pending capsule:
   - Move from pending to user's `user_received:{userId}` list
   - Create in-app notification
   - **Email was already sent** when capsule was originally delivered
3. Return claimed count

**Note:** Capsule delivery emails are sent BEFORE the recipient creates an account, stored as "pending". When they sign up, the capsule moves from pending to their account.

---

## Email Template Components

### **Shared Header** (All Emails)
**Component:** `generateEclipseHeader()`

**Design:**
- **Purple gradient background** (slate ‚Üí indigo ‚Üí violet)
- **Eclipse Logo** (inline SVG)
  - Moon overlapping sun design
  - 80x80px size
- **"ERAS" wordmark** (uppercase, letter-spaced, 42px, white)
- **Tagline:** "Digital Time Capsule" (uppercase, 13px)

**Styling:**
- Email-safe HTML table structure
- Inline styles for maximum compatibility
- No external CSS or images

---

### **Call-to-Action Button**
**Design:**
- Purple gradient background (667eea ‚Üí 764ba2)
- White text, 17px, 600 weight
- 16px vertical padding, 50px horizontal padding
- 8px border radius
- Full-width centered

---

### **Footer** (All Emails)
**Content:**
- Light gray background (#f9fafb)
- Support contact: support@erastimecapsule.com
- Context-specific help text
- Email-safe table structure

---

## Email Deduplication System

**Purpose:** Prevent sending the same capsule delivery email twice

**How It Works:**
1. Before sending, check `email_sent:{viewingToken}:{recipientEmail}` in KV store
2. If already sent, log warning and skip (return success)
3. After successful send, store deduplication record:
   ```javascript
   {
     sent_at: ISO timestamp,
     recipient: email,
     viewing_token: token,
     capsule_title: title
   }
   ```
4. Record stored for 30 days (longer than any retry window)

**Key:** `email_sent:{viewingToken}:{recipientEmail}`

---

## Rate Limiting System

**Resend API Limit:** 2 requests/second  
**Eras Implementation:** 600ms minimum delay (1.67 req/sec - safe buffer)

**Features:**
- **Distributed locking** across multiple Edge Function instances
- **Per-request delay:** 600ms + random jitter (0-100ms)
- **Lock acquisition timeout:** 2 minutes (for large batches)
- **Lock expiration:** 10 seconds (prevents deadlocks)
- **Retry logic:** 3 attempts with exponential backoff (2s ‚Üí 4s ‚Üí 8s)
- **429 handling:** Respects `retry-after` header + 2s buffer

**KV Store Keys:**
- `email_send_lock` - Global lock for email sending
- `email_last_send_time` - Timestamp of last sent email

---

## Customization Guide

### **To Modify Email Content:**

**File to Edit:** `/supabase/functions/server/email-service.tsx`

#### **1. Update Capsule Delivery Email:**
```typescript
// Find: generateCapsuleEmail(data: CapsuleDeliveryData)
// Lines 404-487

// Customize:
- headerText (line 418-420)
- subheaderText (line 422-424)
- closingText (line 426-428)
- Subject lines (lines 512-514)
```

#### **2. Update Password Reset Email:**
```typescript
// Find: sendPasswordResetEmail()
// Lines 605-684

// Customize:
- Subject (line 610)
- Body text (lines 628-648)
- Button text (line 653)
```

#### **3. Update Email Header/Branding:**
```typescript
// Find: generateEclipseHeader()
// Lines 343-402

// Customize:
- Logo SVG (lines 354-375)
- Brand name (line 384)
- Tagline (line 393)
- Background gradient (line 346)
```

#### **4. Update Sending Domain:**
```typescript
// Line 46:
private static fromEmail = 'noreply@erastimecapsule.com';

// Change to your verified domain:
private static fromEmail = 'noreply@yourdomain.com';

// Then verify domain at: https://resend.com/domains
```

---

### **To Enable Delivery Confirmations:**

**File to Edit:** `/supabase/functions/server/delivery-service.tsx`

**Lines to uncomment:**
- Line 604: `await this.sendDeliveryConfirmation(capsule, 'success');`
- Line 615: `await this.sendDeliveryConfirmation(capsule, 'failed');`

**Note:** Re-enabling may cause rate limit issues if you have high delivery volume.

---

## Testing Emails in Development

### **Resend Sandbox Mode:**
- Can only send to verified email addresses
- Domain verification required for production use
- Errors show as 403 "validation_error"

### **How to Test:**
1. **Development:** Add test email addresses at resend.com/audiences
2. **Production:** Verify domain at resend.com/domains
3. **Use verified domain** in `fromEmail` setting

### **Common Errors:**
- **401 Unauthorized:** Invalid API key
- **403 Validation Error:** Domain not verified or sandbox mode
- **429 Rate Limit:** Too many requests too fast

---

## Email Analytics & Monitoring

### **View Sent Emails:**
Visit: https://resend.com/emails

### **Email Events Tracked:**
- ‚úÖ Sent
- ‚úÖ Delivered  
- ‚úÖ Opened (if tracking enabled)
- ‚úÖ Clicked (if tracking enabled)
- ‚úÖ Bounced
- ‚úÖ Complained (spam)

### **Logs to Monitor:**
- `[EMAIL]` prefix in server logs
- Email send timestamps
- Rate limiting delays
- Delivery success/failure

---

## Summary Table

| Email Type | Subject | Trigger | Status | Frequency |
|------------|---------|---------|--------|-----------|
| **Capsule Delivery (Self)** | "Your Time Capsule Has Arrived..." | Scheduled delivery time | ‚úÖ Active | Per capsule |
| **Capsule Delivery (Shared)** | "You've Received a Time Capsule from..." | Scheduled delivery time | ‚úÖ Active | Per capsule |
| **Password Reset** | "Reset Your Eras Password" | User forgot password | ‚úÖ Active | On demand |
| **Delivery Success** | "[SUCCESS] Time capsule delivered..." | Capsule delivered | ‚ùå Disabled | N/A |
| **Delivery Failure** | "[FAILED] Failed to deliver..." | Delivery failed | ‚ùå Disabled | N/A |

---

## Technical Stack

- **Email Provider:** Resend (resend.com)
- **API Endpoint:** https://api.resend.com/emails
- **Authentication:** Bearer token (RESEND_API_KEY)
- **Template Engine:** Plain HTML/CSS (inline styles)
- **Queue System:** Custom distributed locking via KV store
- **Deduplication:** KV store with 30-day retention

---

## Support & Contact

**For Email Issues:**
- Email: support@erastimecapsule.com
- Resend Dashboard: https://resend.com
- API Docs: https://resend.com/docs

**To Update API Key:**
1. Generate new key at: https://resend.com/api-keys
2. Update environment variable: `RESEND_API_KEY`
3. Restart Edge Function

---

**Last Updated:** November 26, 2024  
**Audit Version:** 1.0  
**Total Email Templates:** 2 active + 2 disabled
